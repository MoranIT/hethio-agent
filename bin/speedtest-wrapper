#!/bin/bash

echo "Testing internet speed..."

/opt/minion/bin/speedtest-cli > /opt/minion/log/speedtest.lastrun.log

TIMESTAMP=`date +"%s"`
DATETIME=`date +"%Y-%m-%d %H:%M:%S"`
PUBLICIP=`cat /opt/minion/log/speedtest.lastrun.log | grep 'Testing from' | awk -F'(' '{print $2}' | awk -F ')' '{print $1}'`
RESULTS=`cat /opt/minion/log/speedtest.lastrun.log | grep 'Mbits/s' | awk -F':' '{print $2}' | awk -F' ' '{print $1;}' | awk 'NR%2{printf $0"|";next;}1'`
DOWNLOAD=`echo $RESULTS | awk -F'|' '{print $1}'`
UPLOAD=`echo $RESULTS | awk -F'|' '{print $2}'`

echo "$PUBLICIP|$DATETIME" >> /opt/minion/log/publicip.log
echo "$DOWNLOAD|$UPLOAD|$DATETIME" >> /opt/minion/log/speedtest.log  

HOSTNAME=`hostname -f`

echo "Transmitting Public IP to HomeOffice"
#mosquitto_pub -t "$HOSTNAME/internet/ip" -m "$PUBLICIP" -q 1 -h broker.openmqtt.org -p 8883 --cafile /opt/minion/conf/MoranCA.crt -r
mosquitto_pub -t "$HOSTNAME/internet/ip" -m "$PUBLICIP" -q 1 -h broker.openmqtt.org -r

echo "Transmitting Speedtest Results to HomeOffice"
#mosquitto_pub -t "$HOSTNAME/internet/speed/download" -m "$DOWNLOAD" -q 1 -h broker.openmqtt.org -p 8883 --cafile /opt/minion/conf/MoranCA.crt -r
mosquitto_pub -t "$HOSTNAME/internet/speed/download" -m "$DOWNLOAD" -q 1 -h broker.openmqtt.org -r
#mosquitto_pub -t "$HOSTNAME/internet/speed/upload" -m "$UPLOAD" -q 1 -h broker.openmqtt.org -p 8883 --cafile /opt/minion/conf/MoranCA.crt -r
mosquitto_pub -t "$HOSTNAME/internet/speed/upload" -m "$UPLOAD" -q 1 -h broker.openmqtt.org -r


echo "Done"
