#!/bin/bash
#
# Register with heth.io
#

source globals.sh

if [ "$ID" = "" ]; then

	echo "Registering Device..."

	GUID=`uuidgen`

	#subscribe to reg channel and wait for registration id
	subscribe "register/$GUID" "$MPATH/log/registration.log"
	SUBPID=$!  #grab pid from recently run command

	# Notify server of new device
	publish "register" "$GUID"


	# Now wait for response from registration service
	ID=""
	if [ -f "$MPATH/log/registration.log" ]; then
		ID=`cat $MPATH/log/registration.log`
	fi

	while [ "$ID" = "" ]; do
		sleep 10

		if [ -f "$MPATH/log/registration.log" ]; then
			ID=`cat $MPATH/log/registration.log`
		fi

	done
	echo "Registered ID=$ID"
	echo "ID=$ID" >> /etc/minion.conf

	echo "Stopping registration pid"
	kill $SUBPID

	echo "Done"

else
	echo "Already Registered ID=$ID"

fi